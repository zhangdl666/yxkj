<?php
/**
 * Author: ' Silent
 * Time: 2017/9/12 10:58
 */

namespace Wx\Controller;


use Pc\Model\HotelModel;
use Pc\Model\RmainModel;
use Pc\Model\SalesModel;
use Think\Controller;

class RepairCountController extends BaseController
{
    public $model = 'User';

    /**
     * 维修统计
     */
    public function _initialize()
    {
        // TODO: Change the autogenerated stub
        parent::_initialize();
    }
    public function bindPercentage($data,$field){
        $num = array_sum(i_array_column($data,$field));
        foreach ($data as $key => &$val){
            $val['roportion'] = ($val[$field] / $num) * 100;
        }
        $newArray = array();
        foreach ($data as $keys => $vals){
            if($keys < 5){
                $newArray[] = $vals;
            }
        }
        return $newArray;
    }


    /**
     * 首页加载
     */
    public function index()
    {
        // 准备所需要的数据(只能是安装设备的酒店)
        $data =  M(HotelModel::TABLENAME_HOTEL)->alias('l')
            ->join('left join ' . C('DB_PREFIX') .  SalesModel::TABLENAME_ORDER. ' as s on s.h_id = l.id')
            ->where(array('s.type'=>array('eq',1),'s.status'=>array('eq',4)))
            ->field('l.id,l.name')->select();
        $hotelData = SalesModel::listArrayKey($data,'name');;
        $this->assign('hotel', $hotelData);
        $this->display();
    }

    /**
     * 保养统计图加载
     */
    public function maintainCount()
    {
        $this->display();
    }

    /**
     * 维修统计图加载
     */
    public function RepairCount()
    {
        $onedata = RmainModel::getRepCountMake();
        $all_num = array_sum(i_array_column($onedata['list'], 'num'));
        foreach ($onedata['list'] as $key => &$val) {
            $val['rate'] = round(($val['num'] / $all_num) * 100);
        }
        $threedata = RmainModel::getzhanbi();
        $list = $this->bindPercentage($threedata['list'],'value');
        $this->assign('list',$list);
        $this->assign('typethree', json_encode(i_array_column($threedata['list'], 'name')));
        $this->assign('itemthree', $threedata['item']);
        $this->assign('threedata',$threedata);
        // 保养和维修数据占比统计（产品经理）
        $this->assign('onedata', $onedata);
        $this->assign('type', json_encode(i_array_column($onedata['list'], 'oper_name')));
        $this->assign('item', $onedata['item']);
        $twodata = RmainModel::getRepCountTrend();
        $this->assign('types', $twodata['month']);
        $this->assign('items', $twodata['list']);
        $this->display();
    }

    /**
     * 保养统计图筛选
     */
    public function lifterRepair()
    {
        $quyu = I('get.quyu', '', 'trim');
        $type = I('get.type');
        $htId = I('get.ht_id');
        $startTime = I('get.startTime');
        $endTime = I('get.endTime');
        if($startTime){
            $startTime = sprintf('%s 00:00:00',$startTime);
        }
        if($endTime){
            $endTime = sprintf('%s 23:59:59',$endTime);
        }

        $onedata = RmainModel::liftergetRepCountMake($quyu, $type, $htId, $startTime, $endTime);
        $all_num = array_sum(i_array_column($onedata['list'], 'num'));
        foreach ($onedata['list'] as $key => &$val) {
            $val['rate'] = round(($val['num'] / $all_num) * 100);
        }
        $threedata = RmainModel::getzhanbis($quyu, $type, $htId, $startTime ,$endTime);
        $list = $this->bindPercentage($threedata['list'],'value');
        $this->assign('list',$list);
        $this->assign('typethree', json_encode(i_array_column($threedata['list'], 'name')));
        $this->assign('itemthree', $threedata['item']);
        $this->assign('threedata',$threedata);
        $this->assign('onedata', $onedata);
        $this->assign('type', json_encode(i_array_column($onedata['list'], 'oper_name')));
        $this->assign('item', $onedata['item']);
        $twodata = RmainModel::liftergetRepCountTrend($quyu, $type, $htId, $startTime, $endTime);
        $this->assign('types', $twodata['month']);
        $this->assign('items', json_encode($twodata['list']));
        $this->display(T('RepairCount/RepairCounts'));
    }

    /**
     * 根据酒店获取合同
     */
    public function getContaract()
    {
        $id = I('post.id', 0, 'intval');
        $data = HotelModel::getHotelConID($id);
        $this->ajaxReturn($data);
    }


    public function getRep()
    {
        $data = RmainModel::getRepCountTrend();
        $result['code'] = 0;
        $result['data'] = $data['list'];
        $this->ajaxReturn($result);
    }

}